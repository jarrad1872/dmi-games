<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>{{TITLE}} | DMI Tools</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      background: {{BG_COLOR}}; 
      overflow: hidden;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    #game-container { 
      width: 100vw; 
      height: 100vh; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      position: relative;
    }
    canvas { 
      max-width: 100%; 
      max-height: 100%;
      border-radius: 0;
    }
    .cta-button {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, {{PRIMARY_COLOR}} 0%, {{SECONDARY_COLOR}} 100%);
      color: white;
      padding: 14px 36px;
      border-radius: 30px;
      font-weight: 700;
      text-decoration: none;
      font-size: 16px;
      z-index: 1000;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 0 2px rgba(255,255,255,0.1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      letter-spacing: 0.5px;
    }
    .cta-button:hover { 
      transform: translateX(-50%) translateY(-2px) scale(1.02); 
      box-shadow: 0 12px 40px rgba(0,0,0,0.5), 0 0 0 2px rgba(255,255,255,0.2);
    }
    .branding {
      position: fixed;
      top: 12px;
      left: 12px;
      color: white;
      font-size: 13px;
      font-weight: 600;
      opacity: 0.9;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(0,0,0,0.4);
      padding: 8px 14px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }
    .branding-icon {
      width: 24px;
      height: 24px;
      background: linear-gradient(135deg, {{PRIMARY_COLOR}}, {{SECONDARY_COLOR}});
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="game-container"></div>
  {{#SHOW_BRANDING}}
  <div class="branding">
    <div class="branding-icon">‚öôÔ∏è</div>
    <span>DMI Tools Corp</span>
  </div>
  {{/SHOW_BRANDING}}
  <a href="{{CTA_URL}}" target="_blank" rel="noopener" class="cta-button">{{CTA_TEXT}}</a>
  
  <script>
    // ============================================
    // GAME CONFIGURATION - Edit these values!
    // ============================================
    const CONFIG = {
      title: '{{TITLE}}',
      products: {{PRODUCTS_JSON}},
      theme: {
        primary: '{{PRIMARY_COLOR}}',
        secondary: '{{SECONDARY_COLOR}}',
        bg: '{{BG_COLOR}}'
      },
      difficulty: {{DIFFICULTY}},
      showBranding: {{SHOW_BRANDING}}
    };

    // ============================================
    // BOOT SCENE - Handles loading and textures
    // ============================================
    class BootScene extends Phaser.Scene {
      constructor() {
        super({ key: 'BootScene' });
      }

      preload() {
        const { width, height } = this.scale;
        const barWidth = 300;
        const barHeight = 20;
        const barX = (width - barWidth) / 2;
        const barY = height / 2;
        
        const progressBar = this.add.graphics();
        const progressBox = this.add.graphics();
        progressBox.fillStyle(0x222222, 0.8);
        progressBox.fillRoundedRect(barX, barY, barWidth, barHeight, 10);
        
        this.load.on('progress', (value) => {
          progressBar.clear();
          progressBar.fillStyle(parseInt(CONFIG.theme.primary.replace('#', ''), 16), 1);
          progressBar.fillRoundedRect(barX + 4, barY + 4, (barWidth - 8) * value, barHeight - 8, 6);
        });
      }

      create() {
        this.createTextures();
        this.scene.start('GameScene');
      }

      createTextures() {
        // Player - Tool themed circle with glow
        const playerGfx = this.make.graphics({ add: false });
        playerGfx.fillStyle(parseInt(CONFIG.theme.primary.replace('#', ''), 16), 0.3);
        playerGfx.fillCircle(30, 30, 30);
        playerGfx.fillStyle(parseInt(CONFIG.theme.primary.replace('#', ''), 16));
        playerGfx.fillCircle(30, 30, 22);
        playerGfx.fillStyle(0xffffff, 0.3);
        playerGfx.fillCircle(24, 24, 8);
        playerGfx.fillStyle(0xffffff);
        playerGfx.fillCircle(30, 30, 6);
        playerGfx.generateTexture('player', 60, 60);

        // Pipe with gradient effect
        const pipeGfx = this.make.graphics({ add: false });
        const pipeColor = parseInt(CONFIG.theme.secondary.replace('#', ''), 16);
        pipeGfx.fillStyle(pipeColor);
        pipeGfx.fillRoundedRect(0, 0, 70, 400, { tl: 8, tr: 8, bl: 0, br: 0 });
        pipeGfx.fillStyle(0xffffff, 0.2);
        pipeGfx.fillRect(5, 0, 15, 400);
        pipeGfx.fillStyle(0x000000, 0.2);
        pipeGfx.fillRect(50, 0, 20, 400);
        pipeGfx.fillStyle(pipeColor);
        pipeGfx.fillRoundedRect(-5, 0, 80, 30, 8);
        pipeGfx.generateTexture('pipe', 70, 400);

        // Collectible star
        const collectGfx = this.make.graphics({ add: false });
        collectGfx.fillStyle(0xFFD700);
        collectGfx.fillStar(25, 25, 5, 12, 25);
        collectGfx.fillStyle(0xffffff, 0.5);
        collectGfx.fillStar(22, 22, 5, 5, 10);
        collectGfx.generateTexture('collectible', 50, 50);
      }
    }

    // ============================================
    // GAME SCENE - Main gameplay
    // ============================================
    class GameScene extends Phaser.Scene {
      constructor() {
        super({ key: 'GameScene' });
        this.score = 0;
        this.gameOver = false;
        this.started = false;
        this.highScore = parseInt(localStorage.getItem('dmi-flappy-highscore') || '0');
      }

      create() {
        const { width, height } = this.scale;
        
        // Background gradient
        const bg = this.add.graphics();
        bg.fillGradientStyle(
          parseInt(CONFIG.theme.bg.replace('#', ''), 16),
          parseInt(CONFIG.theme.bg.replace('#', ''), 16),
          0x000000,
          0x000000
        );
        bg.fillRect(0, 0, width, height);

        // Floating particles
        for (let i = 0; i < 20; i++) {
          const dot = this.add.circle(
            Phaser.Math.Between(0, width),
            Phaser.Math.Between(0, height),
            Phaser.Math.Between(1, 3),
            0xffffff,
            0.2
          );
          this.tweens.add({
            targets: dot,
            y: dot.y - 100,
            alpha: 0,
            duration: Phaser.Math.Between(3000, 6000),
            repeat: -1,
            yoyo: true
          });
        }

        // Pipes group
        this.pipes = this.physics.add.group();
        
        // Player
        this.player = this.physics.add.sprite(width * 0.25, height / 2, 'player');
        this.player.setCollideWorldBounds(true);
        this.player.body.setAllowGravity(false);
        this.player.setScale(0.9);
        
        // Collectibles
        this.collectibles = this.physics.add.group();
        
        // Title
        this.titleText = this.add.text(width/2, 60, CONFIG.title, {
          fontSize: '36px',
          fontFamily: 'Inter, sans-serif',
          fill: '#ffffff',
          fontStyle: 'bold'
        }).setOrigin(0.5);

        // Product icons
        if (CONFIG.products.length > 0) {
          const productText = CONFIG.products.map(p => p.icon).join('  ');
          this.add.text(width/2, 105, productText, { fontSize: '28px' }).setOrigin(0.5);
        }

        // Start prompt
        this.startPrompt = this.add.text(width/2, height/2 + 80, 'üëÜ TAP TO START', {
          fontSize: '20px',
          fontFamily: 'Inter, sans-serif',
          fill: '#ffffff',
          fontStyle: 'bold'
        }).setOrigin(0.5);

        this.tweens.add({
          targets: this.startPrompt,
          scale: 1.1,
          alpha: 0.7,
          duration: 800,
          yoyo: true,
          repeat: -1
        });

        // Score display
        this.scoreText = this.add.text(width/2, 60, '0', {
          fontSize: '72px',
          fontFamily: 'Inter, sans-serif',
          fill: '#ffffff',
          fontStyle: 'bold'
        }).setOrigin(0.5).setAlpha(0);

        // Input
        this.input.on('pointerdown', () => this.flap());
        this.input.keyboard.on('keydown-SPACE', () => this.flap());

        // Collisions
        this.physics.add.collider(this.player, this.pipes, () => this.hitPipe());
        this.physics.add.overlap(this.player, this.collectibles, (p, c) => this.collect(c));

        // Pipe spawner
        this.pipeTimer = this.time.addEvent({
          delay: Math.max(1500, 2200 - (CONFIG.difficulty * 80)),
          callback: this.spawnPipes,
          callbackScope: this,
          loop: true,
          paused: true
        });

        // Player idle animation
        this.tweens.add({
          targets: this.player,
          y: this.player.y + 10,
          duration: 1000,
          yoyo: true,
          repeat: -1,
          ease: 'Sine.easeInOut'
        });
      }

      flap() {
        if (this.gameOver) {
          this.score = 0;
          this.scene.restart();
          return;
        }
        
        if (!this.started) {
          this.started = true;
          this.player.body.setAllowGravity(true);
          this.pipeTimer.paused = false;
          this.titleText.setAlpha(0);
          this.startPrompt.setVisible(false);
          this.scoreText.setAlpha(1);
          this.tweens.killTweensOf(this.player);
        }
        
        this.player.setVelocityY(-380);
        
        this.tweens.add({
          targets: this.player,
          scaleX: 1.1,
          scaleY: 0.8,
          duration: 100,
          yoyo: true
        });
      }

      spawnPipes() {
        const { width, height } = this.scale;
        const gap = Math.max(140, 200 - (CONFIG.difficulty * 6));
        const minY = 120;
        const maxY = height - 120 - gap;
        const gapY = Phaser.Math.Between(minY, maxY);
        const speed = -220 - (CONFIG.difficulty * 15);

        const topPipe = this.pipes.create(width + 35, gapY, 'pipe');
        topPipe.body.setAllowGravity(false);
        topPipe.setVelocityX(speed);
        topPipe.setOrigin(0.5, 1);
        topPipe.setFlipY(true);

        const bottomPipe = this.pipes.create(width + 35, gapY + gap, 'pipe');
        bottomPipe.body.setAllowGravity(false);
        bottomPipe.setVelocityX(speed);
        bottomPipe.setOrigin(0.5, 0);

        const scoreZone = this.add.zone(width + 35, height/2, 20, height);
        this.physics.world.enable(scoreZone);
        scoreZone.body.setAllowGravity(false);
        scoreZone.body.setVelocityX(speed);
        this.physics.add.overlap(this.player, scoreZone, () => {
          if (!scoreZone.scored) {
            scoreZone.scored = true;
            this.score++;
            this.scoreText.setText(this.score.toString());
            this.tweens.add({
              targets: this.scoreText,
              scale: 1.2,
              duration: 100,
              yoyo: true
            });
          }
        });

        if (Math.random() > 0.7) {
          const collectible = this.collectibles.create(width + 120, gapY + gap/2, 'collectible');
          collectible.body.setAllowGravity(false);
          collectible.setVelocityX(speed);
          collectible.setScale(0.8);
          this.tweens.add({
            targets: collectible,
            angle: 360,
            duration: 2000,
            repeat: -1
          });
        }
      }

      collect(collectible) {
        for (let i = 0; i < 8; i++) {
          const particle = this.add.circle(collectible.x, collectible.y, 4, 0xFFD700);
          this.tweens.add({
            targets: particle,
            x: particle.x + Phaser.Math.Between(-50, 50),
            y: particle.y + Phaser.Math.Between(-50, 50),
            alpha: 0,
            scale: 0,
            duration: 400,
            onComplete: () => particle.destroy()
          });
        }
        
        collectible.destroy();
        this.score += 5;
        this.scoreText.setText(this.score.toString());
      }

      hitPipe() {
        if (this.gameOver) return;
        this.gameOver = true;
        this.physics.pause();
        this.pipeTimer.paused = true;
        
        this.cameras.main.shake(200, 0.01);
        this.cameras.main.flash(200, 255, 0, 0, false);

        if (this.score > this.highScore) {
          this.highScore = this.score;
          localStorage.setItem('dmi-flappy-highscore', this.highScore.toString());
        }
        
        const { width, height } = this.scale;
        
        const panel = this.add.graphics();
        panel.fillStyle(0x000000, 0.85);
        panel.fillRoundedRect(width/2 - 140, height/2 - 100, 280, 200, 20);
        
        this.add.text(width/2, height/2 - 60, 'GAME OVER', {
          fontSize: '32px',
          fontFamily: 'Inter, sans-serif',
          fill: '#ffffff',
          fontStyle: 'bold'
        }).setOrigin(0.5);

        this.add.text(width/2, height/2 - 10, 'Score: ' + this.score, {
          fontSize: '24px',
          fontFamily: 'Inter, sans-serif',
          fill: CONFIG.theme.primary
        }).setOrigin(0.5);

        this.add.text(width/2, height/2 + 25, 'Best: ' + this.highScore, {
          fontSize: '18px',
          fontFamily: 'Inter, sans-serif',
          fill: '#888888'
        }).setOrigin(0.5);

        const restartBtn = this.add.text(width/2, height/2 + 70, '‚Üª TAP TO RESTART', {
          fontSize: '16px',
          fontFamily: 'Inter, sans-serif',
          fill: '#ffffff',
          fontStyle: 'bold'
        }).setOrigin(0.5);

        this.tweens.add({
          targets: restartBtn,
          alpha: 0.5,
          duration: 600,
          yoyo: true,
          repeat: -1
        });
      }

      update() {
        if (this.started && !this.gameOver) {
          this.pipes.getChildren().forEach(pipe => {
            if (pipe.x < -50) pipe.destroy();
          });
          
          this.collectibles.getChildren().forEach(c => {
            if (c.x < -50) c.destroy();
          });
          
          const targetAngle = Phaser.Math.Clamp(this.player.body.velocity.y / 8, -25, 70);
          this.player.angle = Phaser.Math.Linear(this.player.angle, targetAngle, 0.1);
        }
      }
    }

    // ============================================
    // INITIALIZE GAME
    // ============================================
    const game = new Phaser.Game({
      type: Phaser.AUTO,
      parent: 'game-container',
      width: 400,
      height: 700,
      scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH
      },
      physics: {
        default: 'arcade',
        arcade: { gravity: { y: 900 }, debug: false }
      },
      scene: [BootScene, GameScene],
      render: {
        antialias: true,
        roundPixels: true
      }
    });
  </script>
</body>
</html>
